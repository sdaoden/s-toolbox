#!/bin/sh
#@ gen-uushar-wrapper creates a shar(1)-like shell archive (but with
#@ uuencode(1)d content) of given files (read from STDIN and/or ARGV), that is
#@ itself executable.
#@ Execute it (the generated archive) to invoke any of the programs contained
#@ therein.  On the first run with arguments, the wrapper will create a hidden
#@ directory in your $TMPDIR to unpack the archive therein; without arguments
#@ it'll always print creation time and members shipped.
#
# Copyright (c) 2012 Steffen Daode Nurpmeso <sdaoden@users.sf.net>.
#
# Permission to use, copy, modify, and/or distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.
#
# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

##  --  >8  --  8<  --  ##
ARGS=$@

printf "%s\n%s\n%s\n%s\n\n%s " \
	'Howdy howdy, jo-ho hooo!' \
	'So let us create an uuencoded shell archive of the given utilities.' \
	'Please answer the upcoming questions for this to work.' \
	'You can at any time interrupt with CTRL-C.' \
   'What should be the name of the wrapper:'
read ARCH
[ -f "$ARCH.sh" ] && {
   echo >&2 "$ARCH.sh already exists, bailing out."
   exit 1
}
[ -z "$ARCH" ] && {
   echo >&2 "Cannot use the empty string for that, bailing out."
   exit 1
}
ARCH="$ARCH.sh"

printf "Yay, it'll be $ARCH.\n\n%s\n%s [] " \
   "Is there any subcommand which should be called for '+'?" \
   "(As in: '\$ $ARCH + -arg1 -arg2' -> '\$ XXX -arg1 -arg2')?"
read ARCH_DEFEXEC

printf "\n%s\n%s\n%s\n\t- " \
   "So, we'll then enter a loop to read the member programs to include." \
   "Please terminate your input by giving an empty line."
MEMBERS=
[ ${#ARGS} -ne 0 ] && set -- $ARGS
while :; do
   [ ${#ARGS} -ne 0 ] &&
      { i=$1; shift || break; :; } ||
      { read i; [ x"$i" == x ] && break; }
   if [ ! -x "$i" ]; then
      echo >&2 "$i does not exist or is not executable, bailing out."
      exit 1
   fi
   printf "$i: ok\n\t- "
   [ -z "$MEMBERS" ] && MEMBERS="$i" || MEMBERS="$MEMBERS, $i"
done

# Everything get.set.go, so write the actual shell archive
set -C
printf ".. end of list\nFine, so i'm doing my work now\n"
CREATION_DATE=$(date -u)
trap "rm -rf '$ARCH'" 0

# Header
cat <<\! > "$ARCH"
#!/bin/sh
#@ This file was automatically created by gen-uushar-wrapper, which is
# Copyright (c) 2012 Steffen Daode Nurpmeso <sdaoden@users.sf.net>.
#@ by means of the ISC license.

!

# A shell archive is not a transparent thing either!
printf "# Archive:\nARCH='%s'\n# Created:\nCREATION_DATE='%s'\n" \
      "${ARCH%.sh}" "$CREATION_DATE" \
   >> "$ARCH"
printf "# Executable members:\nMEMBERS='%s'\n# + expansion:\nDEFEXEC='%s'\n" \
      "$MEMBERS" "$ARCH_DEFEXEC" \
   >> "$ARCH"
cat <<\! >> "$ARCH"

[ $# -eq 0 ] && {
   printf "Archive creation: %s\nMembers: %s\n" "$CREATION_DATE" "$MEMBERS"
   exit 0
}

i="$TMPDIR/.$ARCH"
[ -d "$i" ] && {
   export PATH="$i:$PATH"
   [ x"$1" == 'x+' ] && { shift; :; } || { DEFEXEC=$1; shift; }
   i="$i/$DEFEXEC"
   if [ ! -f "$i" ] || [ ! -x "$i" ]; then
      echo >&2 "Sorry, this archive no program '$DEFEXEC', bailing out"
      exit 54
   fi
   exec "$i" "$@"
   echo >&2 "Failed to execute <$DEFEXEC $@>"
   # 71=EX_OSERR
   exit 71
}

printf "The directory\n\t$i\n%s\n" \
   'does not exist, creating it first, and exploding this shell archive.'
mkdir -p "$i" || {
   echo >&2 "Cannot create directory '$i'"
   exit 1
}
cd "$i" || {
   echo >&2 "Cannot enter '$i' to explode shell archive"
   exit 1
}

!

# uuencode(1)d the members to embed
oifs=$IFS
IFS=', '
set -- $MEMBERS
IFS=$oifs
for i; do
   basei=$(basename $i)
   printf "echo 'x - (%s as) %s'\nuudecode << \!\n" \
      "$i" "$basei" >> "$ARCH"
   uuencode -m $i $basei >> "$ARCH"
   printf "!\n# END of '$ uuencode -m $i $basei'\n" >> "$ARCH"
done

printf "\necho '%s'\nexit 0\n" \
      'Shell archive exploded, please rerun the command, now for real..' \
   >> "$ARCH"

# The end
chmod 0755 "$ARCH"
trap - 0
exit 0
# vim:set fenc=utf-8 filetype=sh syntax=sh ts=3 sts=3 sw=3 et tw=79:
